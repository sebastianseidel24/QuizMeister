<!DOCTYPE html>
<html lang="en">

{% include 'head.html' %}

<body>
    {% include 'navbar.html' %}

    <div class="container text-center" id="start_session" style="display: block;">
        <h1 style="padding-bottom: 0px;">- {{ quiz[1] }} -</h1>

        <button class="btn btn-primary btn-lg" type="button" onclick="hostSession('{{ quiz[0] }}', '{{ quiz[1] }}')">
            Dieses Quiz starten
        </button>
    </div>

    <div class="container text-center" id="active_session" style="display: none;">
        <h1 style="padding-bottom: 0px;">- {{ quiz[1] }} -</h1>
        <h3>[Host]</h3>

        <button class="btn btn-primary mb-4" type="button" data-bs-toggle="collapse" data-bs-target="#collapse_players"
            aria-expanded="false" aria-controls="collapse_players"><i class="fa-solid fa-person"></i>
            Aktive Spieler
        </button>

        <div class="collapse" id="collapse_players">
            <ul class="list-group" id="active_players"></ul><br>
        </div>

        <div class="accordion accordion-flush mb-4" id="accordionQuiz">
            {% for question in questions %}
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed d-block text-center" type="button"
                        data-bs-toggle="collapse" data-bs-target="#Q{{ question[1] }}" aria-expanded="false"
                        aria-controls="Q{{ question[1] }}">
                        <strong>Frage {{ question[1] }}</strong>
                    </button>
                </h2>
                <div id="Q{{ question[1] }}" class="accordion-collapse collapse" data-bs-parent="#accordionQuiz">
                    <div class="accordion-body">
                        <p class="fs-5 with-line">
                            <button class="btn btn-primary"
                                onclick="askQuestion('{{ question[0] }}', '{{ question[1] }}')"><i
                                    class="fa-solid fa-clipboard-question"></i> Diese Frage stellen</button>
                        </p>
                        <div class="row row-cols-md-4 justify-content-center">
                            <div class="col-md-3">
                                <p class="with-border"><span class="fw-bold">Kategorie</span><br>{{ question[3] }}</p>
                            </div>
                            <div class="col-md-3">
                                <p class="with-border"><span class="fw-bold">Punkte</span><span
                                        id="points_Q{{ question[1] }}"><br>{{ question[7] }}</span></p>
                            </div>
                        </div>
                        <p class="fs-5 with-line"><span class="fw-bold fs-5">Frage</span><br>{{
                            question[2]|replace('\n', '<br>')|safe }}</p>
                        {% if question[4] != "" %}
                        <p class="fs-5 with-line"><span class="fw-bold">Beschreibung</span><br>{{
                            question[4]|replace('\n', '<br>')|safe }}</p>
                        {% endif %}
                        {% if question[5] != None %}
                        <p class="fs-5 with-line"><span class="fw-bold fs-5">Bild</span><br>
                            <img class="img-fluid" style="max-width: 60%; margin-top: 12px;"
                                src="../static/FileUploads/{{ question[5] }}"></img>
                        </p>
                        {% endif %}
                        <p class="fs-5 with-line"><span class="fw-bold fs-5">Richtige Antwort</span><br>{{
                            question[6]|replace('\n',
                            '<br>')|safe }}</p>
                        <div class="fs-5" id="no_answers_Q{{ question[1] }}"><span class="fw-bold fs-5">Antworten der
                                Spieler</span><br>
                            <span>Bisher wurden keine Antworten abgegeben.</span>
                        </div>

                        <div class="fs-5" id="answers_Q{{ question[1] }}" style="display: none;">
                            <div class="row row-cols-3" style="margin-bottom: 12px;">
                                <div class="col-2 fw-bold">Spielername</div>
                                <div class="col-8 fw-bold">Antworten der Spieler</div>
                                <div class="col-2 fw-bold">Auswertung</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>


        <button class="btn btn-primary mb-4" type="button" id="update_leaderboard"><i
                class="fa-solid fa-rotate-right"></i>
            Punktestand aktualisieren
        </button>

        <!-- Punktestand -->
        <div class="pb-4 mb-4 with-background" id="leaderboard"
            style="background-color: rgb(149 129 219); color: rgb(37 1 91)">
            <h3 style="padding-bottom: 4px; padding-top: 8px; color: rgb(37 1 91);">Leaderboard</h3>
            <!-- Je Teilnehmer eine Row -->
            
            <div class="row justify-content-center fs-5 fw-bold pb-2">
                <div class="col-4 col-md-2">
                    Platzierung
                </div>
                <div class="col-4 col-md-3">
                    Spielername
                </div>
                <div class="col-4 col-md-2">
                    Punkte
                </div>
            </div>
        </div>
        <button class="btn btn-primary mb-3" type="button" id="share_leaderboard_btn"><i class="fa-solid fa-trophy"></i>
            Punktestand teilen
        </button>
    </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.8.1/socket.io.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <script>
        const socket = io({ autoConnect: false });

        function hostSession(quiz_id, quiz_name) {
            socket.connect();
            var quiz_id = Number(quiz_id)
            document.getElementById(`start_session`).style.display = "none";
            document.getElementById(`active_session`).style.display = "block";
            socket.emit("host_session", quiz_id, quiz_name)
        }

        socket.on("new_player", function (quiz_id, quiz_name, playername, points, place) {
            let ul = document.getElementById("active_players");
            let li = document.createElement("li");
            li.className = "list-group-item";
            li.appendChild(document.createTextNode(playername));
            ul.appendChild(li);

            // In Leaderboard aufnehmen
            document.getElementById(`leaderboard`).innerHTML = document.getElementById(`leaderboard`).innerHTML +
                `
            <div class="row justify-content-center fs-5">
                    <div class="col-4 col-md-2" style="color: rgb(199, 146, 12);">
                        <i class="fa-solid fa-medal"></i>
                    </div>
                    <div class="col-4 col-md-3">
                        <span>${playername}</span>
                    </div>
                    <div class="col-4 col-md-2">
                        <span>${points}</span>
                    </div>
                </div>
            `

        });

        function askQuestion(qui_id, que_id) {
            var quiz_id = Number(qui_id);
            var question_id = Number(que_id);
            socket.emit("ask_question", quiz_id, question_id);
            document.getElementById(`answers_Q${question_id}`).innerHTML = `
            <div class="row row-cols-3" style="margin-bottom: 12px;">
                <div class="col-2 fw-bold">Spielername</div>
                <div class="col-8 fw-bold">Antworten der Spieler</div>
                <div class="col-2 fw-bold">Auswertung</div>
            </div>
            `;
            document.getElementById(`no_answers_Q${question_id}`).style.display = "block";
            document.getElementById(`answers_Q${question_id}`).style.display = "none";
        }

        socket.on("send_answer", function (question_id, playername, answer) {
            document.getElementById(`no_answers_Q${question_id}`).style.display = "none";
            document.getElementById(`answers_Q${question_id}`).style.display = "block";

            let points = document.getElementById(`points_Q${question_id}`).innerText;
            points = Number(points);

            document.getElementById(`answers_Q${question_id}`).innerHTML = document.getElementById(`answers_Q${question_id}`).innerHTML + `
            <div class="row row-cols-3 with-border" style="margin-bottom: 8px; padding-left: 0px; padding-right: 0px;">
                <div class="col-2">${playername}</div>
                <div class="col-8">${answer}</div>
                <div class="col-2" style="padding-left: 8px; padding-right: 8px;">
                    <div class="input-group">
                        <input type="radio" class="btn-check" name="options_${question_id}_${playername}" id="correct_${question_id}_${playername}" autocomplete="off">
                        <label class="btn btn-outline-success rounded-start" for="correct_${question_id}_${playername}" style="border-width: 2px; margin-left: 0px;" onclick="setPoints(true, ${question_id}, '${playername}', ${points})"><i class="fa-solid fa-check"></i></label>
                        <input type="radio" class="btn-check" name="options_${question_id}_${playername}" id="wrong_${question_id}_${playername}" autocomplete="off">
                        <label class="btn btn-outline-danger" for="wrong_${question_id}_${playername}" style="border-width: 2px; margin-left: 0px;" onclick="setPoints(false, ${question_id}, '${playername}', ${points})"><i class="fa-solid fa-xmark"></i></label>
                        <input class="form-control" id="points_${question_id}_${playername}" type="number" value="" min="0"
                        max="5" step="0.5" disabled>
                    </div>
                </div>
            </div>`;
        });

        function setPoints(correct, question_id, playername, points) {
            if (correct == true) {
                document.getElementById(`points_${question_id}_${playername}`).disabled = false;
                document.getElementById(`points_${question_id}_${playername}`).value = points;
            } else if (correct == false) {
                document.getElementById(`points_${question_id}_${playername}`).value = 0;
                document.getElementById(`points_${question_id}_${playername}`).disabled = true;
            }
        }


        document.getElementById("update_leaderboard").addEventListener("click", function () {
            const questionDivs = document.getElementsByClassName("accordion-item");
            const activePlayers = document.getElementById("active_players")
            const players = activePlayers.getElementsByClassName("list-group-item")
            let points = 0;

            Array.from(players).forEach((player, index) => {
                let playername = player.innerText
                Array.from(questionDivs).forEach((questionDiv, i) => {
                    if (document.getElementById(`points_${i + 1}_${playername}`)) {
                        let points_to_add = document.getElementById(`points_${i + 1}_${playername}`).value;
                        points_to_add = Number(points_to_add);
                        points = points + points_to_add;
                    }
                });
                socket.emit("calculate_points", playername, points);
                points = 0;
            });

            socket.emit("calculate_leaderboard");
            // Leaderboard zurücksetzen
            document.getElementById("leaderboard").innerHTML = `
                <h3 style="padding-bottom: 4px; padding-top: 8px; color: rgb(37 1 91);">Leaderboard</h3>
                <div class="row justify-content-center fs-5 fw-bold pb-2">
                    <div class="col-4 col-md-2">
                        Platzierung
                    </div>
                    <div class="col-4 col-md-3">
                        Spielername
                    </div>
                    <div class="col-4 col-md-2">
                        Punkte
                    </div>
                </div>
            `;
        });

        socket.on("update_leaderboard", function (place, playername, points) {
            if (place == 1) {
                document.getElementById("leaderboard").innerHTML = document.getElementById("leaderboard").innerHTML + `
                <div class="row justify-content-center fs-5">
                    <div class="col-4 col-md-2" style="color: rgb(199, 146, 12);">
                        <i class="fa-solid fa-medal"></i>
                    </div>
                    <div class="col-4 col-md-3">
                        <span>${playername}</span>
                    </div>
                    <div class="col-4 col-md-2">
                        <span>${points}</span>
                    </div>
                </div>`
            } else if (place == 2) {
                document.getElementById("leaderboard").innerHTML = document.getElementById("leaderboard").innerHTML + `
                <div class="row justify-content-center fs-5">
                    <div class="col-4 col-md-2" style="color: silver;">
                        <i class="fa-solid fa-medal"></i>
                    </div>
                    <div class="col-4 col-md-3">
                        <span>${playername}</span>
                    </div>
                    <div class="col-4 col-md-2">
                        <span>${points}</span>
                    </div>
                </div>`
            } else if (place == 3) {
                document.getElementById("leaderboard").innerHTML = document.getElementById("leaderboard").innerHTML + `
                <div class="row justify-content-center fs-5">
                    <div class="col-4 col-md-2" style="color: #8b5a43;">
                        <i class="fa-solid fa-medal"></i>
                    </div>
                    <div class="col-4 col-md-3">
                        <span>${playername}</span>
                    </div>
                    <div class="col-4 col-md-2">
                        <span>${points}</span>
                    </div>
                </div>`
            } else {
                document.getElementById("leaderboard").innerHTML = document.getElementById("leaderboard").innerHTML + `
                <div class="row justify-content-center fs-5">
                    <div class="col-4 col-md-2 fw-bold">
                        <span>${place}.</span>
                    </div>
                    <div class="col-4 col-md-3">
                        <span>${playername}</span>
                    </div>
                    <div class="col-4 col-md-2">
                        <span>${points}</span>
                    </div>
                </div>
            `
            }
        });

        document.getElementById("share_leaderboard_btn").addEventListener("click", function () {
            socket.emit("share_leaderboard");
        });

    </script>



    {% include 'footer.html' %}
</body>

</html>