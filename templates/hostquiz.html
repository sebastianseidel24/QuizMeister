<!DOCTYPE html>
<html lang="en">

{% include 'head.html' %}

<body>
    {% include 'navbar.html' %}



    <div class="container text-center" id="new_session">
        <h1>- {{ quiz[1] }} - hosten</h1>

        <div class="mb-3">
            <input class="form-control" type="number" id="session_id" name="session_id"
                placeholder="Eine Session-ID vergeben" required>
        </div>
        <button class="btn btn-primary" id="host_session_btn" onclick="hostSession('{{ quiz[1] }}')">Session
            erstellen</button>

    </div>

    <div class="container text-center" id="active_session" style="display: none;">
        <h1 style="padding-bottom: 0px;">- {{ quiz[1] }} -</h1>
        <h3>[Host]</h3>
        <p>Aktive Session: <span id="current_session"></span></p>

        <button class="btn btn-primary mb-4" type="button" data-bs-toggle="collapse" data-bs-target="#collapse_players"
            aria-expanded="false" aria-controls="collapse_players"><i class="fa-solid fa-person"></i>
            Aktive Spieler
        </button>

        <div class="collapse" id="collapse_players">
            <ul class="list-group" id="active_players"></ul><br>
        </div>

        <div class="accordion accordion-flush mb-4" id="accordionQuiz">
            {% for question in questions %}
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed d-block text-center" type="button"
                        data-bs-toggle="collapse" data-bs-target="#Q{{ question[1] }}" aria-expanded="false"
                        aria-controls="Q{{ question[1] }}">
                        <strong>Frage {{ question[1] }}</strong>
                    </button>
                </h2>
                <div id="Q{{ question[1] }}" class="accordion-collapse collapse" data-bs-parent="#accordionQuiz">
                    <div class="accordion-body">
                        <p class="fs-5 with-line">
                            <button class="btn btn-primary"
                                onclick="askQuestion('{{ question[0] }}', '{{ question[1] }}')"><i
                                    class="fa-solid fa-clipboard-question"></i> Diese Frage stellen</button>
                        </p>
                        <div class="row row-cols-md-4 justify-content-center">
                            <div class="col-md-3">
                                <p class="with-border"><span class="fw-bold">Kategorie</span><br>{{ question[3] }}</p>
                            </div>
                            <div class="col-md-3">
                                <p class="with-border"><span class="fw-bold">Punkte</span><span
                                        id="points_Q{{ question[1] }}"><br>{{ question[7] }}</span></p>
                            </div>
                        </div>
                        <p class="fs-5 with-line"><span class="fw-bold fs-5">Frage</span><br>{{
                            question[2]|replace('\n', '<br>')|safe }}</p>
                        {% if question[4] != "" %}
                        <p class="fs-5 with-line"><span class="fw-bold">Beschreibung</span><br>{{
                            question[4]|replace('\n', '<br>')|safe }}</p>
                        {% endif %}
                        {% if question[5] != None %}
                        <p class="fs-5 with-line"><span class="fw-bold fs-5">Bild</span><br>
                            <img class="img-fluid" style="max-width: 60%; margin-top: 12px;"
                                src="../static/FileUploads/{{ question[5] }}"></img>
                        </p>
                        {% endif %}
                        <p class="fs-5 with-line"><span class="fw-bold fs-5">Richtige Antwort</span><br>{{
                            question[6]|replace('\n',
                            '<br>')|safe }}</p>
                        <div class="fs-5" id="no_answers_Q{{ question[1] }}"><span class="fw-bold fs-5">Antworten der
                                Spieler</span><br>
                            <span>Bisher wurden keine Antworten abgegeben.</span>
                        </div>

                        <div class="fs-5" id="answers_Q{{ question[1] }}" style="display: none;">
                            <div class="row row-cols-3" style="margin-bottom: 12px;">
                                <div class="col-2 fw-bold">Spielername</div>
                                <div class="col-8 fw-bold">Antworten der Spieler</div>
                                <div class="col-2 fw-bold">Auswertung</div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Punktestand -->
        <button class="btn btn-primary mb-4" type="button" data-bs-toggle="collapse"
            data-bs-target="#collapse_leaderboard" aria-expanded="false" aria-controls="collapse_leaderboard"><i
                class="fa-solid fa-trophy"></i>
            Aktueller Punktestand
        </button>

        <div class="collapse" id="collapse_leaderboard">
            <canvas id="leaderboard" style="width:100%;max-width:700px;margin: auto;"></canvas>
        </div>

    </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.8.1/socket.io.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js">
    </script>

    <script>
        const socket = io({ autoConnect: false });

        function hostSession(quiz_name) {
            socket.connect();
            let session_id = document.getElementById("session_id").value;
            socket.emit("host_session", quiz_name, session_id)
            //Hier Hosting Formular ausblenden und Fragen einblenden
            document.getElementById("active_session").style.display = "block";
            document.getElementById("new_session").style.display = "none";
            document.getElementById("current_session").innerText = session_id;
        }

        socket.on("new_player", function (quiz_name, session_id, playername) {
            let ul = document.getElementById("active_players");
            let li = document.createElement("li");
            li.className = "list-group-item";
            li.appendChild(document.createTextNode(playername));
            ul.appendChild(li);
        })

        function askQuestion(qui_id, que_id) {
            var quiz_id = Number(qui_id);
            var question_id = Number(que_id);
            socket.emit("ask_question", quiz_id, question_id);
        }

        socket.on("send_answer", function (question_id, playername, answer) {
            document.getElementById(`no_answers_Q${question_id}`).style.display = "none";
            document.getElementById(`answers_Q${question_id}`).style.display = "block";

            let points = document.getElementById(`points_Q${question_id}`).innerText;
            points = Number(points);

            document.getElementById(`answers_Q${question_id}`).innerHTML = document.getElementById(`answers_Q${question_id}`).innerHTML + `
            <div class="row row-cols-3 with-border" style="margin-bottom: 8px; padding-left: 0px; padding-right: 0px;">
                <div class="col-2">${playername}</div>
                <div class="col-8">${answer}</div>
                <div class="col-2" style="padding-left: 8px; padding-right: 8px;">
                    <div class="input-group">
                        <input type="radio" class="btn-check" name="options_${question_id}_${playername}" id="correct_${question_id}_${playername}" autocomplete="off">
                        <label class="btn btn-outline-success rounded-start" for="correct_${question_id}_${playername}" style="border-width: 2px; margin-left: 0px;" onclick="setPoints(true, ${question_id}, '${playername}', ${points})"><i class="fa-solid fa-check"></i></label>
                        <input type="radio" class="btn-check" name="options_${question_id}_${playername}" id="wrong_${question_id}_${playername}" autocomplete="off">
                        <label class="btn btn-outline-danger" for="wrong_${question_id}_${playername}" style="border-width: 2px; margin-left: 0px;" onclick="setPoints(false, ${question_id}, '${playername}', ${points})"><i class="fa-solid fa-xmark"></i></label>
                        <input class="form-control" id="points_${question_id}_${playername}" type="number" value="" min="0"
                        max="5" step="0.5" disabled>
                    </div>
                </div>
            </div>`;
        })

        function setPoints(correct, question_id, playername, points) {
            if (correct == true) {
                document.getElementById(`points_${question_id}_${playername}`).disabled = false;
                document.getElementById(`points_${question_id}_${playername}`).value = points;
            } else if (correct == false) {
                document.getElementById(`points_${question_id}_${playername}`).value = 0;
                document.getElementById(`points_${question_id}_${playername}`).disabled = true;
            }
        }

        // const leaderboard = document.getElementById('leaderborad')
        // leaderboard.addEventListener('hidden.bs.collapse', event => {
        //     leaderboard.scrollIntoView();
        // })


        var playernames = ["Maria", "Sebi", "Luisa"];
        var current_points = [12, 8, 4];

        new Chart("leaderboard", {
            type: "bar",
            data: {
                labels: playernames,
                datasets: [{
                    backgroundColor: "rgb(52, 0, 130)",
                    data: current_points
                }]
            },
            options: {
                legend: { display: false },
                title: {
                    display: false,
                    text: "Leaderboard"
                }
            }
        });


    </script>



    {% include 'footer.html' %}
</body>

</html>